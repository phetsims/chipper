// Copyright 2024, University of Colorado Boulder

/**
 * @author Matt Pennington (PhET Interactive Simulations)
 */

const child_process = require( 'child_process' );
const fs = require( 'fs' );
const localeInfo = require( './localeInfo' );

const newLocaleInfo = {
  _comment: 'This file is automatically generated by js/data/updateLocaleInfo.js. Do not modify it directly.',
  ...localeInfo
};

fs.writeFileSync( '../../data/localeInfo.json', JSON.stringify( newLocaleInfo, null, 2 ) );


let newModuleSourceCode =
  `// Copyright 2015-${new Date().getFullYear()}, University of Colorado Boulder

/**
  * This file is automatically generated by js/data/updateLocaleInfo.js. Do not modify it directly.
  *
  * @author automatically generated by updateLocaleInfo.js
  */

/* eslint-env browser, node */


export default {`;


// Add properties for all locales
for ( const locale in localeInfo ) {
  newModuleSourceCode += `
  ${locale}: {
    name: '${localeInfo[ locale ].name}',
    localizedName: '${localeInfo[ locale ].localizedName}',
    direction: '${localeInfo[ locale ].direction}'
  },`;
}
// Remove the trailing comma
newModuleSourceCode = newModuleSourceCode.slice( 0, -1 );
// Close the object
newModuleSourceCode += '\n};';


fs.writeFileSync( './localeInfoModule.js', newModuleSourceCode );
console.log( 'locale info files updated' );

let needsCommit = true;
try {

  // 0 exit code if there are no working copy changes from HEAD.
  child_process.execSync( 'git diff-index --quiet HEAD --' );
}
catch( e ) {
  needsCommit = false;
  console.log( 'No locale info changes, no commit needed.' );
}

if ( needsCommit ) {
  try {

    console.log( 'pulling' );

    // Some devs have rebase set by default, and you cannot rebase-pull with working copy changes.
    child_process.execSync( 'git pull --no-rebase' );

    child_process.execSync( 'git add ../../data/localeInfo.json' );
    child_process.execSync( 'git add ./localeInfoModule.js' );

    if ( needsCommit ) {
      console.log( 'committing' );
      child_process.execSync( 'git commit --no-verify ../../data/localeInfo.json ./localeInfoModule.js -m "Automatically updated generated localeInfo files"' );
      console.log( 'pushing' );
      child_process.execSync( 'git push' );
    }
  }
  catch( e ) {
    console.error( 'Unable to update files in git.', e );
  }
}